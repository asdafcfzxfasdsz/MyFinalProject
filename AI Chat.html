<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AI Chat</title>
    <link rel="stylesheet" href="css/style.css">

    <style>
        /* ===== Keep same requirements as Travel: active nav pop effect ===== */
        .nav-links a.active{
            display: inline-block;
            transform: translateY(-6px) scale(1.15);
            font-weight: 700;
            animation: navPop 450ms ease-out;
            transition: transform 220ms ease, font-weight 220ms ease;
        }
        @keyframes navPop{
            0%{ transform: translateY(0) scale(1); }
            60%{ transform: translateY(-12px) scale(1.25); }
            100%{ transform: translateY(-6px) scale(1.15); }
        }
        .user-avatar{
            cursor: pointer;
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ===== Weather row (clickable) ===== */
        .weather-row{
            display: flex;
            gap: 16px;
            margin-top: 20px;
            overflow-x: auto;
            padding-bottom: 6px;
        }
        .weather-row::-webkit-scrollbar{ height: 8px; }
        .weather-row::-webkit-scrollbar-thumb{ background: rgba(0,0,0,0.18); border-radius: 999px; }

        .weather-card{
            min-width: 260px;
            height: 120px;
            padding: 18px 18px;
            border-radius: 14px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: transform 180ms ease, box-shadow 180ms ease;
        }
        .weather-card:hover{
            transform: translateY(-2px);
            box-shadow: 0 10px 22px rgba(0,0,0,0.12);
        }
        .weather-card.selected{
            outline: 3px solid rgba(0,0,0,0.25);
            transform: translateY(-4px);
        }
        .weather-card .city{
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 6px;
        }
        .weather-card .temp{
            font-size: 18px;
            font-weight: 700;
            opacity: 0.95;
        }
        .weather-card .icon{
            font-size: 22px;
            opacity: 0.95;
        }

        .weather-panel{
            margin-top: 14px;
            background: #fff;
            border-radius: 14px;
            padding: 14px 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
        }
        .weather-panel .left{
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .weather-panel .title{
            font-weight: 900;
            font-size: 14px;
        }
        .weather-panel .desc{
            font-size: 13px;
            color: rgba(0,0,0,0.65);
        }
        .weather-panel .right{
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .weather-panel input[type="date"]{
            border: 1px solid rgba(0,0,0,0.18);
            border-radius: 10px;
            padding: 8px 10px;
            outline: none;
        }
        .weather-panel button{
            border: none;
            border-radius: 10px;
            padding: 9px 12px;
            cursor: pointer;
            background: #111;
            color: #fff;
            font-weight: 700;
        }

        /* ===== Chat UI ===== */
        .chat-area{
            margin-top: 18px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .chat-messages{
            height: 320px;
            overflow-y: auto;
            padding: 14px 14px;
            background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0));
        }
        .msg{
            display: flex;
            margin-bottom: 10px;
        }
        .msg.user{ justify-content: flex-end; }
        .bubble{
            max-width: 78%;
            padding: 10px 12px;
            border-radius: 14px;
            font-size: 14px;
            line-height: 1.4;
            word-break: break-word;
        }
        .msg.user .bubble{
            background: #111;
            color: #fff;
            border-bottom-right-radius: 6px;
        }
        .msg.bot .bubble{
            background: rgba(0,0,0,0.06);
            color: #111;
            border-bottom-left-radius: 6px;
        }

        .chat-compose{
            padding: 12px 12px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 1px solid rgba(0,0,0,0.08);
        }
        .compose-btn{
            width: 44px;
            height: 44px;
            border-radius: 999px;
            border: 1px solid rgba(0,0,0,0.12);
            background: #fff;
            cursor: pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size: 18px;
        }
        .compose-input{
            flex: 1;
            height: 44px;
            border-radius: 999px;
            border: 1px solid rgba(0,0,0,0.12);
            padding: 0 14px;
            outline: none;
            font-size: 14px;
        }
        .send-btn{
            height: 44px;
            padding: 0 14px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: #111;
            color: #fff;
            font-weight: 800;
        }

        /* Keep your existing banner style (do not remove) */
        .chat-banner{ margin-top: 18px; }
    </style>
</head>

<body>
    <nav class="navbar">
        <ul class="nav-links">
            <li><a href="Travel.html">Travel</a></li>
            <li><a href="AI Chat.html" class="active">AI Chat</a></li>
            <li><a href="Food.html">Food</a></li>
            <li><a href="Guide.html">Guide</a></li>
            <li><a href="Ticket.html">Ticket</a></li>
            <li><a href="Upload.html">Upload</a></li>
        </ul>
        <div class="nav-right">
            <div class="search-bar">
                <span>üîç</span>
                <input type="text" placeholder="Search anything">
            </div>
            <!-- Same as Travel: clickable avatar shows phone -->
            <div class="user-avatar" id="userAvatar" title="Click to go to Login">User</div>
            <span>üè∑Ô∏è</span>
        </div>
    </nav>

    <!-- Keep your hero-section (but make it clickable to details like Travel setup) -->
    <section class="hero-section">
        <a href="details.html?id=p1&topic=travel" class="hero-card">
            <img src="image\1.png" alt="Moscow">
            <div class="hero-text">
                <h3>Red Square In Moscow</h3>
                <p>Ah, The Joy Of The Open Road...</p>
            </div>
        </a>
        <a href="details.html?id=p2&topic=travel" class="hero-card">
            <img src="image\2.png" alt="Night View">
            <div class="hero-text">
                <h3>My Travel To Moscow</h3>
                <p>Download Torrents From Verified...</p>
            </div>
        </a>
        <a href="details.html?id=p3&topic=travel" class="hero-card">
            <img src="image\3.png" alt="Couple">
            <div class="hero-text">
                <h3>We Are In Moscow</h3>
                <p>A Single Monitor Manifesto...</p>
            </div>
        </a>
    </section>

    <div class="content-container">

        <!-- ===== Weather clickable row (like your screenshot) ===== -->
        <div class="weather-row" id="weatherRow">
            <!-- NOTE: City cards are clickable. Temperatures will be updated by JS. -->
            <div class="weather-card" data-city="New York" style="background: white; color: black;">
                <div>
                    <div class="temp"><span class="tmax">--</span>¬∞C</div>
                    <div class="city">New York</div>
                </div>
                <div class="icon">‚õÖ</div>
            </div>

            <div class="weather-card" data-city="Ankara" style="background: orange;">
                <div>
                    <div class="city">Ankara</div>
                    <div class="temp"><span class="tmax">--</span>¬∞C</div>
                </div>
                <div class="icon">‚òÄÔ∏è</div>
            </div>

            <div class="weather-card" data-city="Anchorage" style="background: #4A90E2;">
                <div>
                    <div class="city">Alaska</div>
                    <div class="temp"><span class="tmax">--</span>¬∞C</div>
                </div>
                <div class="icon">‚ùÑÔ∏è</div>
            </div>

            <div class="weather-card" data-city="Berlin" style="background: #7ED321;">
                <div>
                    <div class="city">Berlin</div>
                    <div class="temp"><span class="tmax">--</span>¬∞C</div>
                </div>
                <div class="icon">‚òÅÔ∏è</div>
            </div>

            <div class="weather-card" data-city="Paris" style="background: #9013FE;">
                <div>
                    <div class="city">Paris</div>
                    <div class="temp"><span class="tmax">--</span>¬∞C</div>
                </div>
                <div class="icon">üåô</div>
            </div>
        </div>

        <!-- Weather detail panel: shows today's or selected date weather -->
        <div class="weather-panel">
            <div class="left">
                <div class="title" id="weatherTitle">Weather</div>
                <div class="desc" id="weatherDesc">Select a city to view today's weather.</div>
            </div>
            <div class="right">
                <input type="date" id="weatherDate">
                <button id="checkWeatherBtn">Check</button>
            </div>
        </div>

        <div class="chat-banner">
            The world is wide and bright,<br>
            may every step shine with light.
        </div>

        <!-- ===== Chat area ===== -->
        <div class="chat-area">
            <div class="chat-messages" id="chatMessages">
                <div class="msg bot">
                    <div class="bubble">Hi! Type a message, upload a file, or use the mic.</div>
                </div>
            </div>

            <div class="chat-compose">
                <!-- File upload -->
                <button class="compose-btn" id="attachBtn" title="Upload file">+</button>
                <input type="file" id="fileInput" style="display:none">

                <!-- Text input -->
                <input class="compose-input" id="chatInput" type="text" placeholder="You can type what you want">

                <!-- Voice input -->
                <button class="compose-btn" id="micBtn" title="Voice input">üé§</button>

                <!-- Send -->
                <button class="send-btn" id="sendBtn">Send</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function(){
            /* ===== User avatar: same as Travel ===== */
            const userAvatar = document.getElementById('userAvatar');

            function getCurrentUserPhone(){
                const candidates = [
                    localStorage.getItem('travelAgentCurrentUser'),
                    localStorage.getItem('travelAgentCurrentPhone'),
                    localStorage.getItem('currentUserPhone'),
                    localStorage.getItem('travelAgentLastUser')
                ].filter(Boolean);

                if (candidates.length > 0) return candidates[0];

                // fallback: if only one registered user exists, show it
                try{
                    const users = JSON.parse(localStorage.getItem('travelAgentUsers') || '{}');
                    const keys = Object.keys(users);
                    if (keys.length === 1) return keys[0];
                }catch(e){}

                return '';
            }

            const phone = getCurrentUserPhone();
            userAvatar.textContent = phone ? phone : 'User';
            userAvatar.addEventListener('click', function(){
                window.location.href = 'index.html';
            });

            /* ===== Weather: clickable cards + date ===== */
            // Coordinates for fetching weather (Open-Meteo)
            const cityMap = {
                "New York": { lat: 40.7128, lon: -74.0060 },
                "Ankara": { lat: 39.9334, lon: 32.8597 },
                "Anchorage": { lat: 61.2181, lon: -149.9003 }, // Alaska example
                "Berlin": { lat: 52.5200, lon: 13.4050 },
                "Paris": { lat: 48.8566, lon: 2.3522 }
            };

            const weatherRow = document.getElementById('weatherRow');
            const cards = Array.from(weatherRow.querySelectorAll('.weather-card'));
            const weatherTitle = document.getElementById('weatherTitle');
            const weatherDesc = document.getElementById('weatherDesc');
            const weatherDate = document.getElementById('weatherDate');
            const checkWeatherBtn = document.getElementById('checkWeatherBtn');

            function todayISO(){
                const d = new Date();
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth()+1).padStart(2,'0');
                const dd = String(d.getDate()).padStart(2,'0');
                return `${yyyy}-${mm}-${dd}`;
            }

            weatherDate.value = todayISO();

            let selectedCity = "New York";

            function selectCardByCity(city){
                selectedCity = city;
                cards.forEach(c => c.classList.toggle('selected', c.dataset.city === city));
            }

            function codeToEmoji(code){
                // Simple mapping (Open-Meteo weather codes)
                if (code === 0) return "‚òÄÔ∏è";
                if (code === 1 || code === 2) return "üå§Ô∏è";
                if (code === 3) return "‚òÅÔ∏è";
                if (code >= 45 && code <= 48) return "üå´Ô∏è";
                if (code >= 51 && code <= 57) return "üå¶Ô∏è";
                if (code >= 61 && code <= 67) return "üåßÔ∏è";
                if (code >= 71 && code <= 77) return "‚ùÑÔ∏è";
                if (code >= 80 && code <= 82) return "üåßÔ∏è";
                if (code >= 95) return "‚õàÔ∏è";
                return "‚õÖ";
            }

            async function fetchWeather(city, dateStr){
                const info = cityMap[city];
                if (!info){
                    weatherTitle.textContent = "Weather";
                    weatherDesc.textContent = "Feature under development.";
                    return;
                }

                // Open-Meteo daily forecast (no key required)
                const url =
                    `https://api.open-meteo.com/v1/forecast` +
                    `?latitude=${encodeURIComponent(info.lat)}` +
                    `&longitude=${encodeURIComponent(info.lon)}` +
                    `&daily=temperature_2m_max,temperature_2m_min,weathercode` +
                    `&timezone=auto` +
                    `&start_date=${encodeURIComponent(dateStr)}` +
                    `&end_date=${encodeURIComponent(dateStr)}`;

                try{
                    weatherTitle.textContent = `Weather ¬∑ ${city}`;
                    weatherDesc.textContent = "Loading...";

                    const res = await fetch(url);
                    if (!res.ok) throw new Error("bad response");
                    const data = await res.json();

                    const maxT = data?.daily?.temperature_2m_max?.[0];
                    const minT = data?.daily?.temperature_2m_min?.[0];
                    const code = data?.daily?.weathercode?.[0];

                    if (typeof maxT !== "number" || typeof minT !== "number"){
                        weatherDesc.textContent = "Feature under development.";
                        return;
                    }

                    const emoji = codeToEmoji(code);
                    weatherDesc.textContent = `${dateStr}: ${emoji} Max ${Math.round(maxT)}¬∞C / Min ${Math.round(minT)}¬∞C`;

                    // Update selected card temperature text (max temp)
                    const selected = cards.find(c => c.dataset.city === city);
                    if (selected){
                        const tmaxEl = selected.querySelector('.tmax');
                        if (tmaxEl) tmaxEl.textContent = Math.round(maxT);

                        // Also update the card icon if it exists
                        const iconEl = selected.querySelector('.icon');
                        if (iconEl) iconEl.textContent = emoji;
                    }
                }catch(e){
                    weatherDesc.textContent = "Feature under development.";
                }
            }

            cards.forEach(card => {
                card.addEventListener('click', function(){
                    const city = card.dataset.city;
                    selectCardByCity(city);
                    fetchWeather(city, weatherDate.value || todayISO());
                });
            });

            checkWeatherBtn.addEventListener('click', function(){
                fetchWeather(selectedCity, weatherDate.value || todayISO());
            });

            // Initialize default city
            selectCardByCity(selectedCity);
            fetchWeather(selectedCity, weatherDate.value || todayISO());

            /* ===== Chat: text + file + voice ===== */
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const attachBtn = document.getElementById('attachBtn');
            const fileInput = document.getElementById('fileInput');
            const micBtn = document.getElementById('micBtn');

            function appendMessage(role, text){
                const wrap = document.createElement('div');
                wrap.className = `msg ${role}`;
                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                bubble.textContent = text;
                wrap.appendChild(bubble);
                chatMessages.appendChild(wrap);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // A very simple "mini model" (local rules). If anything fails, reply "Feature under development."
            function miniModelReply(userText){
                const t = (userText || '').trim().toLowerCase();
                if (!t) return "Feature under development.";

                if (t.includes("hello") || t.includes("hi")){
                    return "Hello! How can I help you today?";
                }
                if (t.includes("weather")){
                    return "Tip: Select a city above to view today's or a chosen date's weather.";
                }
                if (t.includes("plan") || t.includes("trip")){
                    return "If you tell me the city and how many days, I can draft a simple itinerary.";
                }
                return "Thanks! I can do simple replies here. Feature under development.";
            }

            function handleSendText(){
                const text = chatInput.value.trim();
                if (!text) return;

                appendMessage('user', text);
                chatInput.value = '';

                // Bot reply
                const reply = miniModelReply(text);
                appendMessage('bot', reply);
            }

            sendBtn.addEventListener('click', handleSendText);

            chatInput.addEventListener('keydown', function(e){
                if (e.key === 'Enter'){
                    e.preventDefault();
                    handleSendText();
                }
            });

            // File upload
            attachBtn.addEventListener('click', function(){
                fileInput.click();
            });

            fileInput.addEventListener('change', function(){
                const file = fileInput.files && fileInput.files[0];
                if (!file) return;

                appendMessage('user', `Uploaded file: ${file.name}`);
                appendMessage('bot', "Feature under development.");
                fileInput.value = '';
            });

            // Voice input (Web Speech API)
            micBtn.addEventListener('click', function(){
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition){
                    appendMessage('bot', "Feature under development.");
                    return;
                }

                try{
                    const recog = new SpeechRecognition();
                    recog.lang = 'en-US';
                    recog.interimResults = false;
                    recog.maxAlternatives = 1;

                    micBtn.textContent = "‚è∫Ô∏è";
                    recog.start();

                    recog.onresult = function(event){
                        const transcript = event.results[0][0].transcript || '';
                        chatInput.value = transcript;
                    };

                    recog.onerror = function(){
                        appendMessage('bot', "Feature under development.");
                    };

                    recog.onend = function(){
                        micBtn.textContent = "üé§";
                    };
                }catch(e){
                    appendMessage('bot', "Feature under development.");
                    micBtn.textContent = "üé§";
                }
            });
        });
    </script>
</body>
</html>
